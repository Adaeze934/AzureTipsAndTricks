(window.webpackJsonp=window.webpackJsonp||[]).push([[218],{654:function(e,t,r){"use strict";r.r(t);var a=r(69),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("div",{staticClass:"custom-block tip"},[r("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),r("p",[e._v("ðŸ”¥  Download the FREE Azure Developer Guide eBook "),r("a",{attrs:{href:"http://aka.ms/azuredevebook?WT.mc_id=docs-azuredevtips-azureappsdev",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),r("OutboundLink")],1),e._v(".")]),e._v(" "),r("p",[e._v("ðŸ’¡ Learn more : "),r("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/api-management/api-management-howto-app-insights?WT.mc_id=docs-azuredevtips-azureappsdev",target:"_blank",rel:"noopener noreferrer"}},[e._v("How to integrate Azure API Management with Application Insights"),r("OutboundLink")],1),e._v(".")]),e._v(" "),r("p",[e._v("ðŸ’¡ Learn more : "),r("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/api-management/api-management-howto-app-insights#what-data-is-added-to-azure-application-insights",target:"_blank",rel:"noopener noreferrer"}},[e._v("Performance implications and log sampling"),r("OutboundLink")],1),e._v(".")])]),e._v(" "),r("p",[e._v("This post was brought to you by "),r("strong",[r("a",{attrs:{href:"https://github.com/abymsft",target:"_blank",rel:"noopener noreferrer"}},[e._v("Abishek Narayan"),r("OutboundLink")],1)]),e._v(".")]),e._v(" "),r("h3",{attrs:{id:"how-to-log-request-response-payload-in-application-insights-for-apis-frontend-by-api-management"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#how-to-log-request-response-payload-in-application-insights-for-apis-frontend-by-api-management"}},[e._v("#")]),e._v(" How to log request/response payload in Application Insights for APIs frontend by API Management")]),e._v(" "),r("h4",{attrs:{id:"need-for-debugging-troubleshooting-request-response-payloads"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#need-for-debugging-troubleshooting-request-response-payloads"}},[e._v("#")]),e._v(" Need for debugging/troubleshooting request/response payloads")]),e._v(" "),r("p",[e._v("When fronting your APIs with an Azure "),r("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/api-management?WT.mc_id=docs-azuredevtips-azureappsdev",target:"_blank",rel:"noopener noreferrer"}},[e._v("API Management Gateway"),r("OutboundLink")],1),e._v(" there is often a need to debug/troubleshoot issues by analysing the request or response payload. In such a scenario we use "),r("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/azure-monitor/azure-monitor-app-hub?WT.mc_id=docs-azuredevtips-azureappsdev",target:"_blank",rel:"noopener noreferrer"}},[e._v("Application Insights"),r("OutboundLink")],1),e._v(" to log and inspect the request/response payloads. To avoid performance issues at API Management level, the configuration to inspect payloads is not enabled by default.")]),e._v(" "),r("h4",{attrs:{id:"prerequisites"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#prerequisites"}},[e._v("#")]),e._v(" Prerequisites")]),e._v(" "),r("p",[e._v("If you want to follow along, you'll need the following:")]),e._v(" "),r("ul",[r("li",[e._v("An Azure subscription (If you don't have an Azure subscription, create a "),r("a",{attrs:{href:"https://azure.microsoft.com/free/?WT.mc_id=azure-azuredevtips-azureappsdev",target:"_blank",rel:"noopener noreferrer"}},[e._v("free account"),r("OutboundLink")],1),e._v(" before you begin)")]),e._v(" "),r("li",[r("a",{attrs:{href:"https://www.postman.com?WT.mc_id=other-azuredevtips-azureappsdev",target:"_blank",rel:"noopener noreferrer"}},[e._v("Postman"),r("OutboundLink")],1),e._v(" to trigger the sample API")]),e._v(" "),r("li",[e._v("A provisioned "),r("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/api-management/get-started-create-service-instance-cli#create-a-resource-group?WT.mc_id=docs-azuredevtips-azureappsdev",target:"_blank",rel:"noopener noreferrer"}},[e._v("API Management resource"),r("OutboundLink")],1)]),e._v(" "),r("li",[e._v("An API (with a POST operation), deployed to Azure (optional) and "),r("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/api-management/import-and-publish?WT.mc_id=docs-azuredevtips-azureappsdev",target:"_blank",rel:"noopener noreferrer"}},[e._v("frontend by API Management"),r("OutboundLink")],1)]),e._v(" "),r("li",[e._v("An Application insights resource "),r("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/api-management/api-management-howto-app-insights?WT.mc_id=docs-azuredevtips-azureappsdev",target:"_blank",rel:"noopener noreferrer"}},[e._v("integrated with API Management"),r("OutboundLink")],1)]),e._v(" "),r("li",[e._v("For analyzing logs\n"),r("ul",[r("li",[e._v("Basic understanding of "),r("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/azure-monitor/log-query/log-analytics-overview#starting-log-analytics?WT.mc_id=docs-azuredevtips-azureappsdev",target:"_blank",rel:"noopener noreferrer"}},[e._v("Log Analytics"),r("OutboundLink")],1)]),e._v(" "),r("li",[e._v("Basic understanding of querying Application Insight tables (we will use the 'response' table)\n"),r("img",{attrs:{src:e.$withBase("/files/appinsights-query-table.png")}})])])])]),e._v(" "),r("h4",{attrs:{id:"steps"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#steps"}},[e._v("#")]),e._v(" Steps")]),e._v(" "),r("ol",[r("li",[e._v("Go to the "),r("a",{attrs:{href:"https://portal.azure.com/?WT.mc_id=azure-azuredevtips-azureappsdev",target:"_blank",rel:"noopener noreferrer"}},[e._v("Azure portal"),r("OutboundLink")],1),e._v(" and navigate to the API Management resource")]),e._v(" "),r("li",[e._v("Under "),r("strong",[e._v("Settings")]),e._v(" "),r("em",[e._v(">>")]),e._v(" select "),r("strong",[e._v("API")])]),e._v(" "),r("li",[e._v("Select the sample API from the right pane")]),e._v(" "),r("li",[e._v("Click the 'Settings' tab")]),e._v(" "),r("li",[e._v("Scroll down to "),r("strong",[e._v("Diagnostics Logs")])]),e._v(" "),r("li",[e._v("Under Application Insights tab, tick the checkbox "),r("strong",[e._v("Enable")])]),e._v(" "),r("li",[e._v("Select the AppInsights resource under "),r("strong",[e._v("Destination")]),e._v(" dropdown")]),e._v(" "),r("li",[e._v("Default sampling 100%")]),e._v(" "),r("li",[e._v("Verbosity "),r("strong",[e._v("Information")])]),e._v(" "),r("li",[e._v("Correlation protocol "),r("strong",[e._v("W3C")])]),e._v(" "),r("li",[e._v("Under "),r("strong",[e._v("Additional settings")]),e._v(" click "),r("strong",[e._v("Advanced Options")])]),e._v(" "),r("li",[e._v("Tick to enable "),r("strong",[e._v("Frontend Request")]),e._v(" and "),r("strong",[e._v("Frontend Response")])]),e._v(" "),r("li",[e._v("Use these settings for "),r("strong",[e._v("Frontend Request")]),e._v(" and "),r("strong",[e._v("Frontend Response")]),e._v(" "),r("ul",[r("li",[e._v("Under "),r("strong",[e._v("Headers to log")]),e._v(" add the value "),r("strong",[e._v("X-Forwarded-For")])]),e._v(" "),r("li",[e._v("Under "),r("strong",[e._v("Number of payload bytes to log (up to 8192)")]),e._v(" specify a value upto 8192 bytes")])])]),e._v(" "),r("li",[e._v("Hit save")]),e._v(" "),r("li",[e._v("Navigate to the application insights resource and open the 'Live Metrics' feature under "),r("strong",[e._v("Investigate")]),e._v(".")]),e._v(" "),r("li",[e._v("Once the metrics have been initialized, open Postman and trigger the POST operation for the API with a sample payload. You should see a spike in the 'request rate' graph")]),e._v(" "),r("li",[e._v("Wait for a few minutes, under Application Insights>>Monitoring>>Logs run the following query")])]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('requests \n| where url == "http://apimanagementurl/apiname/resource"\n| where timestamp >= ago(1h)\n| order by timestamp desc\n\n')])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br"),r("span",{staticClass:"line-number"},[e._v("3")]),r("br"),r("span",{staticClass:"line-number"},[e._v("4")]),r("br"),r("span",{staticClass:"line-number"},[e._v("5")]),r("br")])]),r("ol",{attrs:{start:"18"}},[r("li",[e._v("In the results grid, expand the result row, expand the customDimensions node and then expand the Request-Body node.\n"),r("img",{attrs:{src:e.$withBase("/files/requesttable-payload.png")}})])]),e._v(" "),r("p",[e._v("Thanks to "),r("a",{attrs:{href:"https://www.linkedin.com/in/toddfoust",target:"_blank",rel:"noopener noreferrer"}},[e._v("Todd Foust"),r("OutboundLink")],1),e._v(" for sharing the header value.")])])}),[],!1,null,null,null);t.default=n.exports}}]);